<!--
If you want to include any custom html just before </body>, put it in this file.
Or you can delete these file if you don't need it.
-->
<!-- for example, you could include some js libraries:
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.19.1/vis.js" integrity="sha256-HdIuWBZj4eftihsoDCJoMYjZi6aNVaw7YlUpzKT3ZxI=" crossorigin="anonymous"></script>
-->

  <script>
class crossSiteConsent {
    constructor(cspId, cspWebsites) {
        this.cspId = cspId;
        this.cspWebsites = cspWebsites;

        this.cspExpDays = 182;
        this.iframeLoaded = false;
        this.iframeId = 'onetrustCrossSiteConsent';
        this.iframeDomain = 'https://idyllic-kulfi-7c87be.netlify.app';
        this.consentsList = { C0001: 'necessary', C0003: 'personalization', C0002: 'statistics', C0004: 'marketing', BG32: 'social' };

        this.cspConsentNameWithId = ''.concat('cookieconsent', '_', this.cspId);
        this.timestamp = new Date().getTime();
        this.expDatetime = this.timestamp + (86400000 * this.cspExpDays);
        this.consentId = this.generateUUID(100);

        this.host = document.location.host;
        this.origin = document.location.origin;
        this.pathname = document.location.pathname;
        this.pagePath = ''.concat(this.origin, this.pathname);
        this.iframeUrl = ''.concat(this.iframeDomain, '?referrer=', this.pagePath, '&cspid=', this.cspId, '&cspwebsites=', this.cspWebsites);

        this.disableOnConsentChanged = false;

        this.visitid = window?.utag?.data?.tealium_session_id || '';
        this.visitorid = window?.utag?.data?.tealium_visitor_id || '';
    }

    getLocalConsent() {
        try {
            let consent = JSON.parse(this.getCookie(this.cspConsentNameWithId));
            if (consent.expDatetime <= this.timestamp) {
                consent = null;
            } else if (consent.cspWebsites.includes(this.host) === false) {
                consent = null;
            }
            return consent;
        } catch (err) {
            return null;
        }
    }
    setNewConsent() {
        console.log('test: ' + this.disableOnConsentChanged);
        if (this.disableOnConsentChanged === false) {
            const onetrustActiveGroups = window?.OnetrustActiveGroups || '';
            const consentsApproved = [];
            const consentsDenied = [];

            for (const [key, value] of Object.entries(this.consentsList)) {
                if (onetrustActiveGroups.indexOf(key) > -1) {
                    consentsApproved.push(value);
                } else {
                    consentsDenied.push(value);
                }
            }

            const consents = {
                cspId: this.cspId,
                cspWebsites: this.cspWebsites,
                cspExpDays: this.cspExpDays,
                timestamp: this.timestamp,
                expDatetime: this.expDatetime,
                consentsApproved: consentsApproved,
                consentsDenied: consentsDenied,
                consentId: this.consentId,
                consentDomain: this.origin,
                consentURL: this.pagePath,
                visitid: this.visitid
            };

            this.setCookie(JSON.stringify(consents), this.expDatetime);
            this.messageEventSend('set consent', consents);
            // send to kafka
        }
    }
    setCrossConsent(consentObj) {
        this.disableOnConsentChanged = true;

        console.log('_________________');
        console.log(consentObj);
        console.log(OnetrustActiveGroups);
        console.log('test2: ' + this.disableOnConsentChanged);
        console.log('_________________');

        for (const [key, value] of Object.entries(this.consentsList)) {
            if (consentObj.consentsApproved.indexOf(value) > -1) {
                window?.OneTrust?.UpdateConsent('Category', ''.concat(key, ':1'));
            } else {
                window?.OneTrust?.UpdateConsent('Category', ''.concat(key, ':0'));
            }
        }

        const expDatetime = consentObj?.expDatetime;
        this.setCookie(JSON.stringify(consentObj), expDatetime);
        // send to kafka

        setTimeout(() => {
            this.disableOnConsentChanged = false;
        }, 2000);
    }
    deleteConsent() {
        this.setCookie(this.cspConsentNameWithId, -1);
        this.messageEventSend('delete consent');
    }

    getCookie() {
        const name = ''.concat(this.cspConsentNameWithId, '=');
        const decodedCookie = decodeURIComponent(document.cookie);
        const ca = decodedCookie.split(';');
        for (let i = 0; i < ca.length; i += 1) {
            let c = ca[i];
            while (c.charAt(0) === ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) === 0) {
                return c.substring(name.length, c.length);
            }
        }
        return '';
    }
    setCookie(cvalue, expDatetime) {
        const d = new Date();
        d.setTime(expDatetime);
        const expires = ''.concat('expires=', d.toUTCString());
        document.cookie = ''.concat(this.cspConsentNameWithId, '=', cvalue, ';', expires, ';path=/;SameSite=None;Secure');
    }

    generateUUID(length) {
        /* Generate random ID with timestamp */
        const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!';
        let result = '';
        for (let i = 0; i < length; i += 1) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        result = ''.concat(result, '-', this.timestamp);
        return result;
    }

    messageEventSend(m, c = {}) {
        const messageObj = { message: m, consents: c };
        const iframeElement = document.getElementById(this.iframeId);
        if (iframeElement !== null) {
            iframeElement.contentWindow.postMessage(messageObj, this.iframeDomain);
        }

        console.log('parent messageEventSend: ' + m);
    }
    messageObserve() {
        window.addEventListener('message', (event) => {
            if (event.origin === this.iframeDomain) {
                this.iframeLoaded = true;

                if (event.data.message === 'load') {
                    if (event.data.status === 'return consents') {
                        console.log('return consents');
                        this.setCrossConsent(event.data.consents);
                    } else if (event.data.status === 'no consents') {
                        console.log('no consents');
                        this.utilityOnetrustToggle();
                    } else if (event.data.status === 'invalid URL params') {
                        console.log('invalid URL params');
                    }
                } else {
                    console.log('------------');
                    console.log('received message');
                    console.log(event);
                    console.log('------------');
                }
            }

        });
    }

    insertIframe() {
        const e = document.getElementById(this.iframeId);
        if (e === null) {
            const iframe = document.createElement('iframe');
            iframe.setAttribute('id', this.iframeId);
            iframe.setAttribute('src', this.iframeUrl);
            iframe.setAttribute('style', 'display:none !important;');
            document.body.appendChild(iframe);
        }
    }

    insertOneTrust() {
        let b = {},
            u = {};
        u.data = {
            /* Initialize default tag parameter values here */
            /* Examples: */
            /* "account_id" : "1234567" */
            "base_url": "https://cdn.cookielaw.org/consent/ea1a40ca-a25d-43c5-b96a-fc66e962adac-test/otSDKStub.js",
            "data_domain_script": "ea1a40ca-a25d-43c5-b96a-fc66e962adac-test",
            "custom_svg": ""
            /* A value mapped to "account_id" or "base_url" in TiQ will replace these default values. */
        };

        if (!window.OneTrust && typeof (u.data['base_url']) === 'string' && u.data['base_url'] !== '' && typeof (u.data['data_domain_script']) === 'string' && u.data['data_domain_script'] !== '') {
            ((a, b, c, d) => {
                a = u.data['base_url'];
                b = document;
                c = 'script';
                d = b.createElement(c);
                d.src = a
                d.setAttribute("data-domain-script", u.data['data_domain_script']);
                d.type = 'text/java' + c;
                d.async = true;
                a = b.getElementsByTagName(c)[0];
                a.parentNode.insertBefore(d, a);
            })();

            window.OptanonWrapper = () => {
                window?.OneTrust?.SetAlertBoxClosed();

                // insert iframe. Ensure OneTrust obj has loaded before iframe returns message.
                this.messageObserve();
                this.insertIframe();

                // used in case iframe does not respond within two seconds.
                // Ensures that we always have a consent even if iframe cross-site consent fails
                setTimeout(() => {
                    if (this.iframeLoaded === false) {
                        console.log('consents iframe has not responded within two seconds');
                        this.utilityOnetrustToggle();
                    }
                }, 2000);

                window?.OneTrust?.OnConsentChanged(() => {
                    console.log('Onetrust trigger - new consent');
                    this.setNewConsent();
                });
            }

        }
    }

    utilityOnetrustToggle() {
        const consent = this.getLocalConsent();
        if (consent?.visitid !== '' && this.visitid !== '' && consent?.visitid === this.visitid) {
            // use current consent
        } else {
            // request new consent
            window?.OneTrust?.ToggleInfoDisplay();
        }
    }

    kafkaSendConsent() {
        const te = JSON.stringify({
            tealium_account: 'success-nikita-chtcheglov',
            tealium_profile: 'orange-sandbox',
            consent_event: 'decline_consent',
            tealium_event: 'configure_consent',
            tealium_visitor_id: utag.data["cp.utag_main_v_id"],
        });

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "https://collect.tealiumiq.com/event");
        xhr.send(te);
    }

    main() {
        if (this.cspWebsites.includes(this.host) === true) {
            this.insertOneTrust();
        }
    }
}

const t = new crossSiteConsent('123123', ['sbackp.com', 'sbackp.dk', 'tryg.dk']);
t.main();



  </script>
